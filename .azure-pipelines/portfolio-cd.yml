trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  resourceGroup: portfolio-rg
  location: canadacentral
  appServiceName: bensonibeabuchiportfolio
  appServicePlanName: portfolio-asplan
  imageName: portfolio-app
  storageAccountName: portfolioterraformsa
  containerName: tfstate

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0ï¸âƒ£ Bootstrap Stage (ensure Terraform backend exists)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Bootstrap
  displayName: "Ensure Terraform backend exists"
  jobs:
  - job: createBackend
    displayName: "Create backend resources if missing"
    steps:
      - task: AzureCLI@2
        displayName: "Check/Create Backend RG, Storage, Container"
        inputs:
          azureSubscription: "azure-portfolio-connection"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -e

            echo "ğŸ”¹ Ensuring resource group exists..."
            az group create --name $(resourceGroup) --location $(location) --output none

            echo "ğŸ”¹ Ensuring storage account exists..."
            if ! az storage account show --name $(storageAccountName) --resource-group $(resourceGroup) &>/dev/null; then
              az storage account create \
                --name $(storageAccountName) \
                --resource-group $(resourceGroup) \
                --location $(location) \
                --sku Standard_LRS \
                --kind StorageV2
            else
              echo "Storage account $(storageAccountName) already exists."
            fi

            echo "ğŸ”¹ Ensuring blob container exists..."
            STORAGE_KEY=$(az storage account keys list --account-name $(storageAccountName) --resource-group $(resourceGroup) --query "[0].value" -o tsv)
            if ! az storage container exists --name $(containerName) --account-name $(storageAccountName) --account-key $STORAGE_KEY | grep -q "true"; then
              az storage container create --name $(containerName) --account-name $(storageAccountName) --account-key $STORAGE_KEY
            else
              echo "Container $(containerName) already exists."
            fi

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ Infrastructure Stage (Terraform)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Infrastructure
  displayName: "Provision Infrastructure with Terraform"
  dependsOn: Bootstrap
  jobs:
  - job: terraform
    displayName: "Run Terraform in infra folder"
    steps:
      - checkout: self

      # Install Terraform
      - script: |
          curl -LO https://releases.hashicorp.com/terraform/1.9.7/terraform_1.9.7_linux_amd64.zip
          unzip terraform_1.9.7_linux_amd64.zip
          sudo mv terraform /usr/local/bin/
          terraform -v
        displayName: "Install Terraform"

      # Terraform Init, Plan, Apply
      - task: AzureCLI@2
        displayName: "Run Terraform to Deploy Infrastructure"
        inputs:
          azureSubscription: "azure-portfolio-connection"
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -e
            cd infra

            echo "ğŸ”¹ Fetching Azure authentication context..."
            az account show

            echo "ğŸª„ Initializing Terraform backend..."
            terraform init -reconfigure \
              -backend-config="resource_group_name=$(resourceGroup)" \
              -backend-config="storage_account_name=$(storageAccountName)" \
              -backend-config="container_name=$(containerName)" \
              -backend-config="key=terraform.tfstate"

            echo "ğŸ§  Running Terraform plan..."
            terraform plan -out=tfplan \
              -var "resource_group_name=$(resourceGroup)" \
              -var "location=$(location)" \
              -var "app_service_plan_name=$(appServicePlanName)" \
              -var "app_service_name=$(appServiceName)" \
              -var "dockerhub_username=$(dockerhub_username)" \
              -var "dockerhub_password=$(dockerhub_password)"

            echo "ğŸš€ Applying Terraform..."
            terraform apply -auto-approve tfplan
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Build & Push Docker Image (Docker Hub)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Build
  displayName: "Build and Push Docker Image to Docker Hub"
  dependsOn: Infrastructure
  jobs:
  - job: buildDocker
    displayName: "Build & Push to Docker Hub"
    steps:
      - checkout: self

      - script: |
          echo "Logging into Docker Hub..."
          echo $(dockerhub_password) | docker login -u $(dockerhub_username) --password-stdin

          echo "Building image..."
          docker build -t $(dockerhub_username)/$(imageName):latest .

          echo "Pushing to Docker Hub..."
          docker push $(dockerhub_username)/$(imageName):latest
        displayName: "Build & Push Docker Image"
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Deploy Stage
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Deploy
  displayName: "Deploy Docker Image to Azure App Service"
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: "Deploy to Azure App Service"
    steps:
      - checkout: self

      - task: AzureWebAppContainer@1
        displayName: "Deploy container from Docker Hub"
        inputs:
          azureSubscription: "azure-portfolio-connection"
          appName: "$(appServiceName)"
          imageName: "$(dockerhub_username)/$(imageName):latest"
