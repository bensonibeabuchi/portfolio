trigger: none  # Disable normal branch triggers — we only want to trigger from another pipeline

resources:
  pipelines:
  - pipeline: CD-pipeline     # A name you give to this reference
    source: CI-pipeline     # The name of your Terraform pipeline in Azure DevOps
    trigger:
      branches:
        include:
        - main                  # Optional: only trigger when the infra pipeline runs on 'main'


pool:
  vmImage: ubuntu-latest

variables:
  appServiceName: bensonibeabuchiportfolio
  imageName: portfolio-app
  dockerhub_username: bensonibeabuchi
  dockerhub_password: $(dockerhub_password)
  service_connection: azure-portfolio-connection

stages:
# ──────────────────────────────────────────────
# 2️⃣ Build Stage — Build & Push Docker Image
# ──────────────────────────────────────────────
- stage: Build
  displayName: "Build and Push Docker Image to Docker Hub"
  jobs:
  - job: buildDocker
    displayName: "Build & Push to Docker Hub"
    steps:
      - checkout: self

      - script: |
          echo "Logging into Docker Hub..."
          echo $(dockerhub_password) | docker login -u $(dockerhub_username) --password-stdin

          echo "Building image..."
          docker build -t $(dockerhub_username)/$(imageName):latest .

          echo "Pushing to Docker Hub..."
          docker push $(dockerhub_username)/$(imageName):latest
        displayName: "Build & Push Docker Image"
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# ──────────────────────────────────────────────
# 3️⃣ Deploy Stage — Deploy to Azure App Service
# ──────────────────────────────────────────────
- stage: Deploy
  displayName: "Deploy Docker Image to Azure App Service"
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: "Deploy to Azure App Service"
    steps:
      - checkout: self

      - task: AzureWebAppContainer@1
        displayName: "Deploy container from Docker Hub"
        inputs:
          azureSubscription: "azure-portfolio-connection"
          appName: "$(appServiceName)"
          imageName: "$(dockerhub_username)/$(imageName):latest"
