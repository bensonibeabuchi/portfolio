trigger: none  # Disable normal branch triggers — we only want to trigger from another pipeline

resources:
  pipelines:
  - pipeline: CD-pipeline     # A name you give to this reference
    source: CI-pipeline     # The name of your Terraform pipeline in Azure DevOps
    trigger:
      branches:
        include:
        - main                  # Optional: only trigger when the infra pipeline runs on 'main'


pool:
  vmImage: ubuntu-latest

variables:
- group: portfolio-variables

- name: appServiceName
  value: bensonibeabuchiportfolio

- name: imageName
  value: portfolio-app

- name: dockerhub_username
  value: bensonibeabuchi

- name: service_connection
  value: azure-portfolio-connection

stages:
# ──────────────────────────────────────────────
# 2️⃣ Build Stage — Build & Push Docker Image
# ──────────────────────────────────────────────
- stage: Build
  displayName: "Build and Push Docker Image to Docker Hub"
  jobs:
  - job: buildDocker
    displayName: "Build & Push to Docker Hub"
    steps:
      - checkout: self

      - script: |
          echo "Logging into Docker Hub..."
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

          echo "Building image..."
          docker build -t "$DOCKERHUB_USERNAME/$(imageName):latest" .

          echo "Pushing to Docker Hub..."
          docker push "$DOCKERHUB_USERNAME/$(imageName):latest"
        displayName: "Build & Push Docker Image"
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# ──────────────────────────────────────────────
# 3️⃣ Deploy Stage — Deploy to Azure App Service
# ──────────────────────────────────────────────
- stage: Deploy
  displayName: "Deploy Docker Image to Azure App Service"
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: "Deploy to Azure App Service"
    steps:
      - checkout: self

      - task: AzureWebAppContainer@1
        displayName: "Deploy container from Docker Hub"
        inputs:
          azureSubscription: "$(service_connection)"
          appName: "$(appServiceName)"
          imageName: "$(dockerhub_username)/$(imageName):latest"
