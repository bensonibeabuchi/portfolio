trigger:
  branches:
    include:
      - main

variables:
  imageName: "bensonibeabuchi/portfolio"
  dockerfilePath: "Dockerfile"
  tag: "$(Build.BuildId)"

  resourceGroup: "portfolio-rg"
  storageAccountName: "portfoliostatestorage"
  containerName: "tfstate"
  location: "canadacentral"
  appServicePlanName: "portfolio-appserviceplan"
  appServiceName: "portfolio-webapp"

stages:
  # =====================
  # 1Ô∏è‚É£ Build & Push Stage
  # =====================
  - stage: BuildAndPush
    displayName: "üê≥ Build and Push Docker Image"
    jobs:
      - job: DockerBuild
        displayName: "Build & Push Docker Image to Docker Hub"
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - checkout: self
            clean: true

          - task: Docker@2
            displayName: "Build and Push Image"
            inputs:
              command: buildAndPush
              repository: "$(imageName)"
              dockerfile: "$(dockerfilePath)"
              containerRegistry: "DockerHubConnection"
              tags: |
                latest
                $(tag)

  # =====================
  # 2Ô∏è‚É£ Bootstrap Backend
  # =====================
  - stage: Bootstrap
    displayName: "üå± Terraform Backend Setup"
    dependsOn: BuildAndPush
    jobs:
      - job: SetupBackend
        displayName: "Create Resource Group + Storage Account for Terraform State"
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - task: AzureCLI@2
            displayName: "Create Terraform State Backend"
            inputs:
              azureSubscription: "azure-portfolio-connection"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                echo "üîπ Checking Azure login context..."
                az account show

                echo "üîπ Creating Resource Group (if not exists)..."
                az group create \
                  --name $(resourceGroup) \
                  --location $(location)

                echo "üîπ Creating Storage Account (if not exists)..."
                az storage account create \
                  --name $(storageAccountName) \
                  --resource-group $(resourceGroup) \
                  --location $(location) \
                  --sku Standard_LRS \
                  --allow-blob-public-access false

                echo "üîπ Creating Blob Container (if not exists)..."
                az storage container create \
                  --name $(containerName) \
                  --account-name $(storageAccountName)

  # =====================
  # 3Ô∏è‚É£ Terraform Deploy
  # =====================
  - stage: DeployInfrastructure
    displayName: "üèóÔ∏è Terraform Init, Plan, and Apply"
    dependsOn: Bootstrap
    jobs:
      - job: Terraform
        displayName: "Terraform Apply"
        pool:
          vmImage: "ubuntu-latest"

        steps:
          - checkout: self
            clean: true

          - task: AzureCLI@2
            displayName: "Run Terraform"
            inputs:
              azureSubscription: "azure-portfolio-connection"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -e
                cd infra

                echo "üîπ Authenticating via OIDC..."
                az account show

                export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)
                export ARM_TENANT_ID=$(az account show --query tenantId -o tsv)
                export ARM_USE_OIDC=true
                export ARM_CLIENT_ID=$(servicePrincipalId)

                echo "‚úÖ Subscription ID: $ARM_SUBSCRIPTION_ID"
                echo "‚úÖ Tenant ID: $ARM_TENANT_ID"

                echo "ü™Ñ Initializing Terraform backend..."
                terraform init -reconfigure \
                  -backend-config="resource_group_name=$(resourceGroup)" \
                  -backend-config="storage_account_name=$(storageAccountName)" \
                  -backend-config="container_name=$(containerName)" \
                  -backend-config="key=terraform.tfstate"

                echo "üß† Terraform plan..."
                terraform plan -out=tfplan \
                  -var "resource_group_name=$(resourceGroup)" \
                  -var "location=$(location)" \
                  -var "app_service_plan_name=$(appServicePlanName)" \
                  -var "app_service_name=$(appServiceName)" \
                  -var "dockerhub_username=$(dockerhub_username)" \
                  -var "dockerhub_password=$(dockerhub_password)" \
                  -var "docker_image=$(imageName):latest"

                echo "üöÄ Terraform apply..."
                terraform apply -auto-approve tfplan
            env:
              ARM_USE_OIDC: true
              ARM_CLIENT_ID: $(servicePrincipalId)
              dockerhub_username: $(dockerhub_username)
              dockerhub_password: $(dockerhub_password)
