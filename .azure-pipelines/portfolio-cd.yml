trigger:
- main

pool:
  vmImage: ubuntu-latest

stages:
- stage: Terraform
  displayName: 'Terraform Infrastructure Deployment'
  jobs:
  - job: terraform
    displayName: 'Provision Infrastructure with Terraform'
    steps:
    # 1ï¸âƒ£ Install Terraform
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    # 2ï¸âƒ£ Azure login & Terraform steps
    - task: AzureCLI@2
      displayName: 'Terraform: Init, Import, Plan, Apply'
      inputs:
        azureSubscription: 'azure-portfolio-connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ğŸ“¦ Switching to infra directory"
          cd infra

          echo "ğŸš€ Initializing Terraform backend..."
          terraform init -reconfigure \
            -backend-config="resource_group_name=portfolio-rg" \
            -backend-config="storage_account_name=portfolioterraformsa" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

          # Import existing resource group if not managed
          terraform state list | grep azurerm_resource_group.rg
          if [ $? -ne 0 ]; then
            echo "ğŸ“¦ Importing existing resource group into Terraform state..."
            terraform import azurerm_resource_group.rg /subscriptions/b728acf7-1a7a-4ac6-b8d8-73fc18c8a1a1/resourceGroups/portfolio-rg
          else
            echo "âœ… Resource group already managed by Terraform"
          fi

          echo "ğŸ§© Validating Terraform configuration..."
          terraform validate

          echo "ğŸª„ Running Terraform Plan..."
          terraform plan -out=tfplan -var-file=terraform.tfvars

          echo "âš™ï¸ Applying Terraform..."
          terraform apply -auto-approve tfplan


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Build & Push Docker Image (Docker Hub)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Build
  displayName: "Build and Push Docker Image to Docker Hub"
  dependsOn: Infrastructure
  jobs:
  - job: buildDocker
    displayName: "Build & Push to Docker Hub"
    steps:
      - checkout: self

      - script: |
          echo "Logging into Docker Hub..."
          echo $(dockerhub_password) | docker login -u $(dockerhub_username) --password-stdin

          echo "Building image..."
          docker build -t $(dockerhub_username)/$(imageName):latest .

          echo "Pushing to Docker Hub..."
          docker push $(dockerhub_username)/$(imageName):latest
        displayName: "Build & Push Docker Image"
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Deploy Stage
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Deploy
  displayName: "Deploy Docker Image to Azure App Service"
  dependsOn: Build
  jobs:
  - job: deploy
    displayName: "Deploy to Azure App Service"
    steps:
      - checkout: self

      - task: AzureWebAppContainer@1
        displayName: "Deploy container from Docker Hub"
        inputs:
          azureSubscription: "azure-portfolio-connection"
          appName: "$(appServiceName)"
          imageName: "$(dockerhub_username)/$(imageName):latest"
