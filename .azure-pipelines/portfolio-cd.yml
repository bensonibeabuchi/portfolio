trigger: none  # Disable normal branch triggers â€” we only want to trigger from another pipeline

resources:
  pipelines:
  - pipeline: CD-pipeline     # A name you give to this reference
    source: CI-pipeline     # The name of your Terraform pipeline in Azure DevOps
    trigger:
      branches:
        include:
        - main                  # Optional: only trigger when the infra pipeline runs on 'main'


pool:
  vmImage: ubuntu-latest

variables:
- group: portfolio-variables

- name: appServiceName
  value: bensonibeabuchiportfolio

- name: imageName
  value: portfolio-app

- name: dockerhub_username
  value: bensonibeabuchi

- name: service_connection
  value: azure-portfolio-connection

stages:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ Build Stage â€” Build & Push Docker Image
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Build
  displayName: "Build and Push Docker Image to Docker Hub"
  jobs:
  - job: buildDocker
    displayName: "Build & Push to Docker Hub"
    steps:
      - checkout: self

      - script: |
          echo "Logging into Docker Hub..."
          echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin

          echo "Building image..."
          docker build -t "$DOCKERHUB_USERNAME/$(imageName):latest" .

          echo "Pushing to Docker Hub..."
          docker push "$DOCKERHUB_USERNAME/$(imageName):latest"
        displayName: "Build & Push Docker Image"
        env:
          dockerhub_username: $(dockerhub_username)
          dockerhub_password: $(dockerhub_password)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ Deploy Stage â€” Deploy to Azure App Service
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- stage: Deploy
  displayName: "Deploy Docker Image to Azure App Service"
  dependsOn: Build
  condition: succeeded()   # only if Build succeeds
  jobs:
  - deployment: DeployToProduction
    displayName: "Deploy to Production Environment"
    environment: 'production'   # ğŸ‘ˆ Must match the environment name you created
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: AzureWebAppContainer@1
              displayName: "Deploy container from Docker Hub"
              inputs:
                azureSubscription: "$(service_connection)"
                appName: "$(appServiceName)"
                imageName: "$(dockerhub_username)/$(imageName):latest"
