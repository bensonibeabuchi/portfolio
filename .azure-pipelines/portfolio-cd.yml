trigger:
  branches:
    include:
      - main

pool:
  vmImage: ubuntu-latest

variables:
  imageName: portfolio-app
  acrName: portfolioacrregistry3691        
  resourceGroup: portfolio-rg
  appServiceName: portfolio-asname  
  location: canadacentral

steps:
  - checkout: self

  # Step 1 - Log in to Azure
  - task: AzureCLI@2
    displayName: "Login to Azure"
    inputs:
      azureSubscription: "azure-portfolio-connection"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        echo "âœ… Logged into Azure"
  
  - task: AzureCLI@2
    displayName: "Run Terraform (infra)"
    inputs:
      azureSubscription: "azure-connection"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        cd infra
        terraform init
        terraform apply -auto-approve


  # Step 2 - Log in to Azure Container Registry
  - task: AzureCLI@2
    displayName: "Log in to Azure Container Registry"
    inputs:
      azureSubscription: "azure-portfolio-connection"
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az acr login --name $ACRNAME
    env:
      ACRNAME: $(acrName)

  # Step 3 - Build and push Docker image to ACR
  - task: Docker@2
    displayName: "Build and Push Docker image to ACR"
    inputs:
      containerRegistry: "portfolio-acr-connection"
      repository: $(imageName)
      command: buildAndPush
      Dockerfile: "**/Dockerfile"
      tags: |
        latest
        $(Build.BuildId)

  # Step 4 - Deploy to Azure App Service
  - task: AzureWebAppContainer@1
    displayName: "Deploy container to Azure App Service"
    inputs:
      azureSubscription: "azure-portfolio-connection"
      appName: "$(appServiceName)"
      imageName: "$(acrName).azurecr.io/$(imageName):latest"
