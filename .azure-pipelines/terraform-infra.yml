trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  - name: environment
    value: dev

stages:
- stage: Terraform
  displayName: 'Terraform Infrastructure Deployment'
  jobs:
  - job: terraform
    displayName: 'Provision Infrastructure with Terraform'
    steps:
    # 1Ô∏è‚É£ Install Terraform
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    # 2Ô∏è‚É£ Azure Login and Terraform Execution
    - task: AzureCLI@2
      displayName: 'Run Terraform to Provision Infrastructure'
      inputs:
        azureSubscription: 'azure-portfolio-connection'  # <-- Your Azure Service Connection
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üì¶ Switching to infra directory"
          cd infra

          echo "üöÄ Initializing Terraform..."
          terraform init \
            -backend-config="resource_group_name=portfolio-rg" \
            -backend-config="storage_account_name=portfolioterraformsa" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

          echo "üß© Validating Terraform configuration..."
          terraform validate

          echo "ü™Ñ Running Terraform Plan..."
          terraform plan -out=tfplan

          echo "‚öôÔ∏è Applying Terraform..."
          terraform apply -auto-approve tfplan
